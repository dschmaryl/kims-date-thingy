var Calendar=Class.create();Calendar.VERSION="1.2",Calendar.DAY_NAMES=new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"),Calendar.SHORT_DAY_NAMES=new Array("S","M","T","W","T","F","S","S"),Calendar.MONTH_NAMES=new Array("January","February","March","April","May","June","July","August","September","October","November","December"),Calendar.SHORT_MONTH_NAMES=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"),Calendar.NAV_PREVIOUS_YEAR=-2,Calendar.NAV_PREVIOUS_MONTH=-1,Calendar.NAV_TODAY=0,Calendar.NAV_NEXT_MONTH=1,Calendar.NAV_NEXT_YEAR=2,Calendar._checkCalendar=function(a){if(!window._popupCalendar)return!1;if(!Element.descendantOf(Event.element(a),window._popupCalendar.container))return window._popupCalendar.callCloseHandler(),Event.stop(a)},Calendar.handleMouseDownEvent=function(a){Event.observe(document,"mouseup",Calendar.handleMouseUpEvent),Event.stop(a)},Calendar.handleMouseUpEvent=function(a){function i(a){var b=f.getDate(),c=f.getMonthDays(a);b>c&&f.setDate(c),f.setMonth(a)}var b=Event.element(a),c=b.calendar,d=!1;if(!c)return!1;if("undefined"==typeof b.navAction){c.currentDateElement&&(Element.removeClassName(c.currentDateElement,"selected"),Element.addClassName(b,"selected"),c.shouldClose=c.currentDateElement==b,c.shouldClose||(c.currentDateElement=b)),c.date.setDateOnly(b.date),d=!0,c.shouldClose=!b.hasClassName("otherDay");var e=!c.shouldClose;e&&c.update(c.date)}else{var f=new Date(c.date);b.navAction==Calendar.NAV_TODAY&&f.setDateOnly(new Date);var g=f.getFullYear(),h=f.getMonth();switch(b.navAction){case Calendar.NAV_PREVIOUS_YEAR:g>c.minYear&&f.setFullYear(g-1);break;case Calendar.NAV_PREVIOUS_MONTH:h>0?i(h-1):g-- >c.minYear&&(f.setFullYear(g),i(11));break;case Calendar.NAV_TODAY:break;case Calendar.NAV_NEXT_MONTH:h<11?i(h+1):g<c.maxYear&&(f.setFullYear(g+1),i(0));break;case Calendar.NAV_NEXT_YEAR:g<c.maxYear&&f.setFullYear(g+1)}f.equalsTo(c.date)?0==b.navAction&&(d=c.shouldClose=!0):(c.setDate(f),d=!0)}return d&&a&&c.callSelectHandler(),c.shouldClose&&a&&c.callCloseHandler(),Event.stopObserving(document,"mouseup",Calendar.handleMouseUpEvent),Event.stop(a)},Calendar.defaultSelectHandler=function(a){return!!a.dateField&&("DIV"==a.dateField.tagName?Element.update(a.dateField,a.date.print(a.dateFormat)):"INPUT"==a.dateField.tagName&&(a.dateField.value=a.date.print(a.dateFormat)),"function"==typeof a.dateField.onchange&&a.dateField.onchange(),void(a.shouldClose&&a.callCloseHandler()))},Calendar.defaultCloseHandler=function(a){a.hide()},Calendar.setup=function(a){function b(b,c){a[b]||(a[b]=c)}if(b("dateField",null),b("triggerElement",null),b("parentElement",null),b("selectHandler",null),b("closeHandler",null),a.parentElement){var c=new Calendar(a.parentElement);return c.setSelectHandler(a.selectHandler||Calendar.defaultSelectHandler),a.dateFormat&&c.setDateFormat(a.dateFormat),a.dateField&&(c.setDateField(a.dateField),c.parseDate(c.dateField.innerHTML||c.dateField.value)),c.show(),c}var d=$(a.triggerElement||a.dateField);d.onclick=function(){var b=new Calendar;return b.setSelectHandler(a.selectHandler||Calendar.defaultSelectHandler),b.setCloseHandler(a.closeHandler||Calendar.defaultCloseHandler),a.dateFormat&&b.setDateFormat(a.dateFormat),a.dateField&&(b.setDateField(a.dateField),b.parseDate(b.dateField.innerHTML||b.dateField.value)),a.dateField&&Date.parseDate(b.dateField.value||b.dateField.innerHTML,b.dateFormat),b.showAtElement(d),b}},Calendar.prototype={container:null,selectHandler:null,closeHandler:null,minYear:1900,maxYear:2100,dateFormat:"%Y-%m-%d",date:new Date,currentDateElement:null,shouldClose:!1,isPopup:!0,dateField:null,initialize:function(a){a?this.create($(a)):this.create()},update:function(a){var b=this,c=new Date,d=c.getFullYear(),e=c.getMonth(),f=c.getDate(),g=a.getMonth(),h=a.getDate();a.getFullYear()<this.minYear?a.setFullYear(this.minYear):a.getFullYear()>this.maxYear&&a.setFullYear(this.maxYear),this.date=new Date(a),a.setDate(1),a.setDate(-a.getDay()+1),Element.getElementsBySelector(this.container,"tbody tr").each(function(c,i){var j=!1;c.immediateDescendants().each(function(c,i){var k=a.getDate(),l=a.getDay(),m=a.getMonth()==g;c.className="",c.date=new Date(a),c.update(k),m?j=!0:c.addClassName("otherDay"),m&&k==h&&(c.addClassName("selected"),b.currentDateElement=c),a.getFullYear()==d&&a.getMonth()==e&&k==f&&c.addClassName("today"),[0,6].indexOf(l)!=-1&&c.addClassName("weekend"),a.setDate(k+1)}),j?c.show():c.hide()}),this.container.getElementsBySelector("td.title")[0].update(Calendar.MONTH_NAMES[g]+" "+this.date.getFullYear())},create:function(a){a?this.isPopup=!1:(a=document.getElementsByTagName("body")[0],this.isPopup=!0);var b=new Element("table"),c=new Element("thead");b.appendChild(c);var d=new Element("tr"),e=new Element("td",{colSpan:7});e.addClassName("title"),d.appendChild(e),c.appendChild(d),d=new Element("tr"),this._drawButtonCell(d,"&#x00ab;",1,Calendar.NAV_PREVIOUS_YEAR),this._drawButtonCell(d,"&#x2039;",1,Calendar.NAV_PREVIOUS_MONTH),this._drawButtonCell(d,"Today",3,Calendar.NAV_TODAY),this._drawButtonCell(d,"&#x203a;",1,Calendar.NAV_NEXT_MONTH),this._drawButtonCell(d,"&#x00bb;",1,Calendar.NAV_NEXT_YEAR),c.appendChild(d),d=new Element("tr");for(var f=0;f<7;++f)e=new Element("th").update(Calendar.SHORT_DAY_NAMES[f]),0!=f&&6!=f||e.addClassName("weekend"),d.appendChild(e);c.appendChild(d);var g=b.appendChild(new Element("tbody"));for(f=6;f>0;--f){d=g.appendChild(new Element("tr")),d.addClassName("days");for(var h=7;h>0;--h)e=d.appendChild(new Element("td")),e.calendar=this}this.container=new Element("div"),this.container.addClassName("calendar"),this.isPopup&&(this.container.setStyle({position:"absolute",display:"none"}),this.container.addClassName("popup")),this.container.appendChild(b),this.update(this.date),Event.observe(this.container,"mousedown",Calendar.handleMouseDownEvent),a.appendChild(this.container)},_drawButtonCell:function(a,b,c,d){var e=new Element("td");return c>1&&(e.colSpan=c),e.className="button",e.calendar=this,e.navAction=d,e.innerHTML=b,e.unselectable="on",a.appendChild(e),e},callSelectHandler:function(){this.selectHandler&&this.selectHandler(this,this.date.print(this.dateFormat))},callCloseHandler:function(){this.closeHandler&&this.closeHandler(this)},show:function(){this.container.show(),this.isPopup&&(window._popupCalendar=this,Event.observe(document,"mousedown",Calendar._checkCalendar))},showAt:function(a,b){this.container.setStyle({left:a+"px",top:b+"px"}),this.show()},showAtElement:function(a){var b=Position.cumulativeOffset(a);this.showAt(b[0],b[1])},hide:function(){this.isPopup&&Event.stopObserving(document,"mousedown",Calendar._checkCalendar),this.container.hide()},parseDate:function(a,b){b||(b=this.dateFormat),this.setDate(Date.parseDate(a,b))},setSelectHandler:function(a){this.selectHandler=a},setCloseHandler:function(a){this.closeHandler=a},setDate:function(a){a.equalsTo(this.date)||this.update(a)},setDateFormat:function(a){this.dateFormat=a},setDateField:function(a){this.dateField=$(a)},setRange:function(a,b){this.minYear=a,this.maxYear=b}},window._popupCalendar=null,Date.DAYS_IN_MONTH=new Array(31,28,31,30,31,30,31,31,30,31,30,31),Date.SECOND=1e3,Date.MINUTE=60*Date.SECOND,Date.HOUR=60*Date.MINUTE,Date.DAY=24*Date.HOUR,Date.WEEK=7*Date.DAY,Date.parseDate=function(a,b){var c=new Date,d=0,e=-1,f=0,g=a.split(/\W+/),h=b.match(/%./g),i=0,j=0,k=0,l=0;for(i=0;i<g.length;++i)if(g[i])switch(h[i]){case"%d":case"%e":f=parseInt(g[i],10);break;case"%m":e=parseInt(g[i],10)-1;break;case"%Y":case"%y":d=parseInt(g[i],10),d<100&&(d+=d>29?1900:2e3);break;case"%b":case"%B":for(j=0;j<12;++j)if(Calendar.MONTH_NAMES[j].substr(0,g[i].length).toLowerCase()==g[i].toLowerCase()){e=j;break}break;case"%H":case"%I":case"%k":case"%l":k=parseInt(g[i],10);break;case"%P":case"%p":/pm/i.test(g[i])&&k<12?k+=12:/am/i.test(g[i])&&k>=12&&(k-=12);break;case"%M":l=parseInt(g[i],10)}if(isNaN(d)&&(d=c.getFullYear()),isNaN(e)&&(e=c.getMonth()),isNaN(f)&&(f=c.getDate()),isNaN(k)&&(k=c.getHours()),isNaN(l)&&(l=c.getMinutes()),0!=d&&e!=-1&&0!=f)return new Date(d,e,f,k,l,0);for(d=0,e=-1,f=0,i=0;i<g.length;++i)if(g[i].search(/[a-zA-Z]+/)!=-1){var m=-1;for(j=0;j<12;++j)if(Calendar.MONTH_NAMES[j].substr(0,g[i].length).toLowerCase()==g[i].toLowerCase()){m=j;break}m!=-1&&(e!=-1&&(f=e+1),e=m)}else parseInt(g[i],10)<=12&&e==-1?e=g[i]-1:parseInt(g[i],10)>31&&0==d?(d=parseInt(g[i],10),d<100&&(d+=d>29?1900:2e3)):0==f&&(f=g[i]);return 0==d&&(d=c.getFullYear()),e!=-1&&0!=f?new Date(d,e,f,k,l,0):c},Date.prototype.getMonthDays=function(a){var b=this.getFullYear();return"undefined"==typeof a&&(a=this.getMonth()),0!=b%4||0==b%100&&0!=b%400||1!=a?Date.DAYS_IN_MONTH[a]:29},Date.prototype.getDayOfYear=function(){var a=new Date(this.getFullYear(),this.getMonth(),this.getDate(),0,0,0),b=new Date(this.getFullYear(),0,0,0,0,0),c=a-b;return Math.floor(c/Date.DAY)},Date.prototype.getWeekNumber=function(){var a=new Date(this.getFullYear(),this.getMonth(),this.getDate(),0,0,0),b=a.getDay();a.setDate(a.getDate()-(b+6)%7+3);var c=a.valueOf();return a.setMonth(0),a.setDate(4),Math.round((c-a.valueOf())/6048e5)+1},Date.prototype.equalsTo=function(a){return this.getFullYear()==a.getFullYear()&&this.getMonth()==a.getMonth()&&this.getDate()==a.getDate()&&this.getHours()==a.getHours()&&this.getMinutes()==a.getMinutes()},Date.prototype.setDateOnly=function(a){var b=new Date(a);this.setDate(1),this.setFullYear(b.getFullYear()),this.setMonth(b.getMonth()),this.setDate(b.getDate())},Date.prototype.print=function(a){var b=this.getMonth(),c=this.getDate(),d=this.getFullYear(),e=this.getWeekNumber(),f=this.getDay(),g={},h=this.getHours(),i=h>=12,j=i?h-12:h,k=this.getDayOfYear();0==j&&(j=12);var l=this.getMinutes(),m=this.getSeconds();return g["%a"]=Calendar.SHORT_DAY_NAMES[f],g["%A"]=Calendar.DAY_NAMES[f],g["%b"]=Calendar.SHORT_MONTH_NAMES[b],g["%B"]=Calendar.MONTH_NAMES[b],g["%C"]=1+Math.floor(d/100),g["%d"]=c<10?"0"+c:c,g["%e"]=c,g["%H"]=h<10?"0"+h:h,g["%I"]=j<10?"0"+j:j,g["%j"]=k<100?k<10?"00"+k:"0"+k:k,g["%k"]=h,g["%l"]=j,g["%m"]=b<9?"0"+(1+b):1+b,g["%M"]=l<10?"0"+l:l,g["%n"]="\n",g["%p"]=i?"PM":"AM",g["%P"]=i?"pm":"am",g["%s"]=Math.floor(this.getTime()/1e3),g["%S"]=m<10?"0"+m:m,g["%t"]="\t",g["%U"]=g["%W"]=g["%V"]=e<10?"0"+e:e,g["%u"]=f+1,g["%w"]=f,g["%y"]=(""+d).substr(2,2),g["%Y"]=d,g["%%"]="%",a.gsub(/%./,function(a){return g[a]||a})},Date.prototype.__msh_oldSetFullYear=Date.prototype.setFullYear,Date.prototype.setFullYear=function(a){var b=new Date(this);b.__msh_oldSetFullYear(a),b.getMonth()!=this.getMonth()&&this.setDate(28),this.__msh_oldSetFullYear(a)};